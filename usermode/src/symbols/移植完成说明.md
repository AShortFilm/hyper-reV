# HyperDbg 符号系统移植完成说明

## 移植总结

已成功将 HyperDbg 的符号解析系统移植到 hyper-reV 项目的 usermode 模块中，为调试器教学提供完整的符号解析能力。

## 移植完成的功能

### ✅ 核心功能
1. **进程附加** - 通过 PID 附加到任意进程进行符号解析
2. **模块列表** - 列出被附加进程的所有已加载模块
3. **符号解析** - 将符号名称转换为地址（如 `ntdll!NtCreateFile`）
4. **地址反解析** - 将地址转换回符号名称
5. **内存读取** - 从被附加进程读取虚拟内存
6. **符号服务器** - 自动从 Microsoft 符号服务器下载 PDB

### ✅ 新增命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `sap <pid>` | 附加到进程 | `sap 1234` |
| `sdp` | 从进程分离 | `sdp` |
| `slm` | 列出模块 | `slm` |
| `srs <symbol>` | 解析符号地址 | `srs ntdll!NtCreateFile` |
| `sra <address>` | 解析地址符号 | `sra 0x7FFE12340000` |
| `srm <addr> <size>` | 读取内存 | `srm 0x7FFE12340000 64` |

## 技术实现

### 架构设计
采用简化的现代化设计，而非直接移植 HyperDbg 的完整 pdbex + symbol-parser 架构：

- **API 层**：直接使用 Windows DbgHelp API
- **语言特性**：C++20/23 现代特性（std::optional, std::print, std::scoped_lock）
- **集成方式**：CLI11 命令框架集成
- **依赖管理**：仅依赖 Windows SDK 的 DbgHelp.lib

### 文件结构
```
usermode/src/symbols/
├── symbol_manager.h              # 核心符号系统接口
├── symbol_manager.cpp            # DbgHelp API 实现
├── symbol_commands.h             # CLI 命令定义
├── symbol_commands.cpp           # 命令处理器
├── README.md                     # 英文文档
└── 移植完成说明.md              # 本文档
```

### 代码修改
1. **main.cpp**: 添加符号系统初始化和清理
   ```cpp
   symbols::initialize();   // 程序启动时
   symbols::shutdown();     // 程序退出时
   ```

2. **commands.cpp**: 集成符号命令
   ```cpp
   #include "../symbols/symbol_commands.h"
   symbol_commands::init_commands(app, aliases_transformer);
   ```

3. **usermode.vcxproj**: 添加构建配置
   - 链接 DbgHelp.lib
   - 添加符号源文件到编译列表

## 使用场景示例

### 场景 1: 查找 API 函数地址
```
> sap 5678
attached to process 5678

> srs ntdll!NtCreateFile
ntdll!NtCreateFile = 0x7FFE12340000

> srs kernel32!CreateFileW
kernel32!CreateFileW = 0x7FF812450000
```

### 场景 2: 分析进程内存布局
```
> sap 1234
attached to process 1234

> slm
ntdll.dll - base: 0x7FFE0000, size: 0x1F0000 - C:\Windows\System32\ntdll.dll
kernel32.dll - base: 0x7FF80000, size: 0x100000 - C:\Windows\System32\kernel32.dll
user32.dll - base: 0x7FFA0000, size: 0x150000 - C:\Windows\System32\user32.dll
```

### 场景 3: 结合 hyper-reV 钩子功能
```
# 1. 找到要钩子的函数地址
> srs ntdll!NtReadFile
ntdll!NtReadFile = 0x7FFE12380000

# 2. 使用 hyper-reV 的内核钩子功能
> akh 0x7FFE12380000 --monitor

# 3. 触发钩子后查看日志
> fl
```

### 场景 4: 内存分析
```
> sap 9876
> srs user32!MessageBoxW
user32!MessageBoxW = 0x7FFA12340000

> srm 0x7FFA12340000 128
memory at 0x7FFA12340000:
48 89 5C 24 08 48 89 6C 24 10 48 89 74 24 18 57
48 83 EC 30 41 8B F9 49 8B F0 8B EA 48 8B D9 E8
...
```

## 与原版 HyperDbg 的区别

### 简化的设计
| 方面 | HyperDbg | hyper-reV 移植版 |
|------|----------|------------------|
| PDB 解析 | 自定义 pdbex | Windows DbgHelp |
| 远程调试 | 支持 | 不支持（本地） |
| 内核符号 | 完整支持 | 待扩展 |
| 用户态符号 | 完整支持 | 完整支持 ✅ |
| 类型信息 | 支持 | 待扩展 |
| 依赖项 | pdbex.dll + SDK | 仅 DbgHelp.lib |

### 设计理念
- **教学优先**: 专注于调试器教学所需的核心功能
- **简洁实现**: 使用系统 API 而非自定义实现
- **现代 C++**: 利用 C++20/23 新特性提高代码质量
- **易于维护**: 减少外部依赖，降低维护成本

## 符号服务器配置

### 默认配置
- 使用 Microsoft 公共符号服务器
- 符号下载路径：`C:\Symbols\`
- 服务器地址：`https://msdl.microsoft.com/download/symbols`

### 自定义配置
设置环境变量 `_NT_SYMBOL_PATH`：
```batch
set _NT_SYMBOL_PATH=srv*C:\MySymbols*https://msdl.microsoft.com/download/symbols;C:\LocalSymbols
```

## 调试器教学价值

通过这个符号系统，学生可以学习：

1. **符号解析原理** - 调试器如何使用 PDB 文件解析符号
2. **进程内存布局** - 理解模块加载和内存组织
3. **API 地址映射** - 函数名如何映射到可执行地址
4. **调试工作流程** - 专业调试器的使用技巧
5. **符号格式** - Microsoft PDB 格式和符号服务器协议

## 后续增强方向

### 短期计划
1. **内核模块符号** - 支持 `nt!*` 和 `ntoskrnl!*` 符号解析
2. **符号缓存** - 缓存常用符号提高性能

### 中期计划
3. **类型信息** - 显示结构体定义和字段偏移
4. **调用栈** - 实现栈回溯功能
5. **符号搜索** - 支持通配符/正则表达式搜索

### 长期计划
6. **源码行信息** - 地址映射到源文件行号
7. **内联函数** - 处理内联函数符号
8. **多进程管理** - 同时管理多个进程的符号

## 编译要求

- **工具集**: Visual Studio 2022 (v143)
- **C++ 标准**: C++latest (C++20/23)
- **运行时库**: 静态多线程 (`/MT` release, `/MTd` debug)
- **SDK**: Windows 10 SDK (提供 DbgHelp.lib)
- **依赖**: CLI11 (项目已包含)

## 测试建议

### 基础功能测试
```
1. 启动 usermode.exe
2. 找一个正在运行的进程 PID（如记事本）
3. 测试: sap <pid>
4. 测试: slm
5. 测试: srs ntdll!RtlInitUnicodeString
6. 测试: sdp
```

### 进阶功能测试
```
1. 依次附加到多个进程
2. 解析不同模块的符号
3. 读取解析出的地址内存
4. 测试错误情况（无效 PID、错误符号名）
```

## 移植成果

✅ **核心功能完整** - 所有教学必需的符号解析功能均已实现  
✅ **现代化实现** - 使用 C++20/23 和系统 API  
✅ **无缝集成** - 与现有 hyper-reV 基础设施完美配合  
✅ **扩展基础** - 为未来增强功能奠定基础  
✅ **教学价值** - 展示专业调试器符号解析技术  

符号系统移植成功，为 hyper-reV 提供了强大的符号解析能力，既是实用工具，也是理解调试器符号系统的优秀教学资源。

## 相关文档

- [英文文档](README.md) - 详细的技术文档和 API 说明
- [移植总结](../../SYMBOL_MIGRATION_SUMMARY.md) - 完整的移植过程和决策说明
- [移植说明](../../../hyperdbg符号系统/移植说明.md) - 原始移植需求文档
